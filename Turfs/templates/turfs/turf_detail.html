<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ turf.name }} - Turfie</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00C853; --primary-dark: #009624; --secondary: #FF6D00;
            --dark: #212121; --gray: #757575; --light-gray: #f5f7fa; --white: #FFFFFF;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12); --shadow-md: 0 4px 6px rgba(0,0,0,0.16);
            --transition: all 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--light-gray); color: var(--dark); }
        .header { background: var(--white); box-shadow: var(--shadow-sm); padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .nav { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: 700; color: var(--primary); text-decoration: none; display: flex; align-items: center; }
        .logo i { margin-right: 10px; }
        .back-link { font-weight: 600; color: var(--dark); text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .main-content { padding: 40px 0; }
        .turf-header { margin-bottom: 20px; }
        .turf-title { font-size: 36px; font-weight: 700; margin-bottom: 5px; }
        .turf-meta { display: flex; align-items: center; gap: 20px; color: var(--gray); }
        .turf-meta-item { display: flex; align-items: center; gap: 8px; }
        .turf-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; align-items: flex-start; }
        .turf-gallery img { width: 100%; height: 450px; object-fit: cover; border-radius: 12px; box-shadow: var(--shadow-md); }
        .turf-info { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: var(--shadow-sm); }
        .section-title { font-size: 20px; font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .turf-description { line-height: 1.7; color: var(--gray); margin-bottom: 25px; }
        .amenities-list { list-style: none; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .amenity-item { display: flex; align-items: center; gap: 10px; }
        .amenity-item i { color: var(--primary); width: 20px; text-align: center; }
        .booking-card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: var(--shadow-sm); position: sticky; top: 100px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .btn { width: 100%; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: var(--transition); border: none; font-size: 16px; text-decoration: none; text-align: center; display: block; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover { background: var(--primary-dark); }
        .time-slots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-top: 20px; }
        .time-slot { padding: 10px; border: 2px solid #ddd; border-radius: 6px; text-align: center; font-weight: 500; }
        .time-slot.available { background: #E8F5E9; color: var(--primary-dark); cursor: pointer; }
        .time-slot.available:hover { border-color: var(--primary); }
        .time-slot.booked { background: #FBE9E7; color: #D32F2F; cursor: not-allowed; text-decoration: line-through; border-color: #FFCCBC; }
        .time-slot.selected { background: #BBDEFB; border-color: #2196F3; color: #1976D2; font-weight: 700; }
        @media (max-width: 992px) { .turf-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="container nav">
            <a href="{% url 'users:dashboard_player' %}" class="logo"><i class="fas fa-futbol"></i> Turfie</a>
            <a href="{{ request.META.HTTP_REFERER|default:request.user.get_dashboard_url }}" class="back-link"><i class="fas fa-arrow-left"></i> Back</a>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="turf-header">
                <h1 class="turf-title">{{ turf.name }}</h1>
                <div class="turf-meta">
                    <div class="turf-meta-item"><i class="fas fa-star" style="color: #FFAB00;"></i><span>{{ turf.rating|floatformat:1 }} ({{ turf.review_count }} reviews)</span></div>
                    <div class="turf-meta-item"><i class="fas fa-map-marker-alt"></i><span>{{ turf.city }}, {{ turf.district }}</span></div>
                </div>
            </div>

            <div class="turf-layout">
                <div class="turf-details-column">
                    <div class="turf-gallery">
                        {% if turf.main_image %}<img src="{{ turf.main_image.url }}" alt="{{ turf.name }}">{% else %}<img src="https://placehold.co/800x450/E0E0E0/757575?text=No+Image" alt="No image available">{% endif %}
                    </div>
                    <div class="turf-info" style="margin-top: 30px;">
                        <h2 class="section-title">About this turf</h2>
                        <p class="turf-description">{{ turf.description|linebreaksbr|default:"No description provided." }}</p>
                        <h2 class="section-title">Amenities</h2>
                        <ul class="amenities-list">
                            {% for amenity in turf.amenities.all %}<li class="amenity-item"><i class="{{ amenity.icon_class|default:'fas fa-check-circle' }}"></i> {{ amenity.name }}</li>{% empty %}<li>No amenities listed.</li>{% endfor %}
                        </ul>
                    </div>
                </div>

                <div class="turf-booking-column">
                    <aside class="booking-card">
                        <h2 class="section-title">Book Your Slot</h2>
                        <div class="form-group">
                            <label for="date-selector">Select Date</label>
                            <input type="date" id="date-selector" name="date" class="form-control" value="{{ selected_date|date:'Y-m-d' }}">
                        </div>
                        <div class="time-slots-grid" id="time-slots-container">
                            {% for slot in time_slots %}
                                <div class="time-slot {% if slot.is_booked %}booked{% else %}available{% endif %}" data-time="{{ slot.start_time|time:'H:i' }}">
                                    {{ slot.start_time|time:'g:i A' }}
                                </div>
                            {% empty %}
                                <p>No time slots available for this day.</p>
                            {% endfor %}
                        </div>

                        <form action="{% url 'turfs:turf_detail' turf.id %}" method="POST" style="margin-top: 20px;">
                            {% csrf_token %}
                            {{ booking_form.non_field_errors }}
                            <div style="display: none;">
                                {{ booking_form.date }}
                                {{ booking_form.start_time }}
                                {{ booking_form.end_time }}
                            </div>
                            <p id="selected-slot-text" style="text-align: center; font-weight: 600; margin-bottom: 15px; color: var(--primary-dark); min-height: 20px;"></p>
                            <button type="submit" id="book-now-btn" class="btn btn-primary" disabled>Select a Start Time</button>
                        </form>
                    </aside>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dateSelector = document.getElementById('date-selector');
            const slotsContainer = document.getElementById('time-slots-container');
            const bookBtn = document.getElementById('book-now-btn');
            const selectedSlotText = document.getElementById('selected-slot-text');

            const dateField = document.querySelector('[name=date]');
            const startTimeField = document.querySelector('[name=start_time]');
            const endTimeField = document.querySelector('[name=end_time]');

            let startSlot = null;
            let endSlot = null;

            dateSelector.addEventListener('change', function() {
                window.location.href = `?date=${this.value}`;
            });

            slotsContainer.addEventListener('click', function(e) {
                if (!e.target.classList.contains('available')) return;

                const clickedSlot = e.target;

                if (!startSlot) {
                    // First click: setting the start time
                    startSlot = clickedSlot;
                    startSlot.classList.add('selected');
                    bookBtn.textContent = 'Select an End Time';
                    updateSelectedText();
                } else if (clickedSlot === startSlot) {
                    // Clicking the same slot again: deselect it
                    resetSelection();
                } else {
                    // Second click: setting the end time
                    endSlot = clickedSlot;
                    validateAndHighlightRange();
                }
            });

            function validateAndHighlightRange() {
                const allSlots = Array.from(slotsContainer.querySelectorAll('.time-slot'));
                const startIndex = allSlots.indexOf(startSlot);
                const endIndex = allSlots.indexOf(endSlot);

                // Ensure start is before end
                if (startIndex > endIndex) {
                    resetSelection();
                    alert("End time must be after the start time.");
                    return;
                }

                // Check for booked slots within the range
                for (let i = startIndex; i <= endIndex; i++) {
                    if (allSlots[i].classList.contains('booked')) {
                        resetSelection();
                        alert("The selected range includes a booked slot. Please choose a different range.");
                        return;
                    }
                }

                // If valid, highlight the range
                allSlots.forEach((slot, i) => {
                    if (i >= startIndex && i <= endIndex) {
                        slot.classList.add('selected');
                    }
                });

                updateFormAndButton();
            }
            
            function updateFormAndButton() {
                const startTime = startSlot.dataset.time;
                const endTimeRaw = endSlot.dataset.time;
                
                // End time is the start of the next hour
                const [h, m] = endTimeRaw.split(':');
                const endHours = (parseInt(h) + 1).toString().padStart(2, '0');
                const endTime = `${endHours}:${m}`;

                dateField.value = dateSelector.value;
                startTimeField.value = startTime;
                endTimeField.value = endTime;

                bookBtn.disabled = false;
                bookBtn.textContent = 'Proceed to Book';
                updateSelectedText();
            }

            function updateSelectedText() {
                if (!startSlot) {
                    selectedSlotText.textContent = '';
                    return;
                }
                const startText = startSlot.textContent.trim();
                if (!endSlot) {
                    selectedSlotText.textContent = `Start: ${startText}`;
                    return;
                }
                const endTextRaw = endSlot.textContent.trim();
                // Calculate the end time text (e.g., 10:00 AM becomes 11:00 AM)
                const endHour = parseInt(endTextRaw.split(':')[0]);
                const endAmPm = endTextRaw.includes('AM') ? 'AM' : 'PM';
                let nextHour = endHour + 1;
                let nextAmPm = endAmPm;
                if (endHour === 11 && endAmPm === 'AM') { nextHour = 12; nextAmPm = 'PM'; }
                else if (endHour === 12 && endAmPm === 'PM') { nextHour = 1; nextAmPm = 'AM'; }
                else if (endHour === 11 && endAmPm === 'PM') { nextHour = 12; nextAmPm = 'AM'; }

                const endText = `${nextHour}:00 ${nextAmPm}`;

                selectedSlotText.textContent = `Selected: ${startText} - ${endText}`;
            }

            function resetSelection() {
                slotsContainer.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                startSlot = null;
                endSlot = null;
                bookBtn.disabled = true;
                bookBtn.textContent = 'Select a Start Time';
                updateSelectedText();
                // Clear form fields
                startTimeField.value = '';
                endTimeField.value = '';
            }
        });
    </script>
</body>
</html>
